---
title: "Aggregate PGS p-values"
author: "XSun"
date: "2024-10-27"
output:
  workflowr::wflow_html:
    code_folding: hide
    toc: true
---

```{r warning=F,message=F}
library(ggplot2)
library(ACAT)
library(dplyr)
library(readxl)
source("/project/xinhe/xsun/r_functions/qqplot_sigle.R")
```

# Introduction

We use ACAT to aggregate the p-values from the traits of the same group.


```{r}
file_path <- "/project/xinhe/xsun/cart/1.pgs/data/MULTIVARIATE_LOGIT_PHENOTYPE_for_XS.xlsx"
num_sheets <- length(excel_sheets(file_path))

allcategroy <- list()
allcategroy_df <- c()
names <- c()
acat_all <- c()
for (i in 2:num_sheets) {
  
  pgs_categroy <- read_xlsx(file_path,sheet = i)
  
  pgs_categroy$P_value[pgs_categroy$P_value == 1] <- 1-1/nrow(pgs_categroy)
  
  acat_group <- ACAT(as.numeric(pgs_categroy$P_value))
  acat_all <- c(acat_all,acat_group)
  
  name_current <- unique(pgs_categroy$Trait_category)[1]
  names <- c(names,name_current)
  
  allcategroy[[i-1]] <- pgs_categroy
  
  allcategroy_df <- rbind(allcategroy_df,pgs_categroy)
}

DT::datatable(allcategroy_df ,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','P-values for PGS'),options = list(pageLength = 5) )

```


# Results

```{r}

acat_df_all <- data.frame(categroy = names, acat_p = acat_all)
names(allcategroy) <- names

acat_df_all <- acat_df_all[order(as.numeric(acat_df_all$acat_p)),]

DT::datatable(acat_df_all,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','ACAT p-values for each group'),options = list(pageLength = 10) )


qqplot(as.numeric(acat_df_all$acat_p))
```

The 4 categories with ACAT p-values < 0.05


```{r}

sig_cats <- unique(acat_df_all$categroy[acat_df_all$acat_p < 0.05])

for (i in 1:length(sig_cats)) {
  trait_category <- allcategroy_df$Reported_Trait[allcategroy_df$Trait_category %in% sig_cats[i]]
  trait_list <- paste0("  - ", unique(trait_category), collapse = "\n")
  cat(sprintf("Traits in category %d (%s):\n%s\n\n", i, sig_cats[i], trait_list))
}


groups_acat <- allcategroy_df[allcategroy_df$Trait_category %in% acat_df_all$categroy[acat_df_all$acat_p < 0.05],]
DT::datatable(groups_acat,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','The 4 groups with ACAT p-values < 0.05'),options = list(pageLength = 10) )
```
